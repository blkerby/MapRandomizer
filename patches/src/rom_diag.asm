arch snes.cpu
lorom

!bank_80_free_space_start = $8085F6 ; this is where the sram/region check used to live.
!bank_80_free_space_end = $80875B   ; and this is where it ended.
!sram_msg_end = $80BC37

; $1f89: bank
; $1f8a: offset
; $1f8c: checksum


; $80:855F 20 F6 85    JSR $85F6  [$80:85F6]  ; NTSC/PAL and SRAM mapping check
							
org $80855F						; original call to the SRAM routine, we can use this to setup our RAM variables.
		JSR hook_init 
		
;$80:8343 AD B4 05    LDA $05B4  [$7E:05B4]  ;\
;$80:8346 D0 FB       BNE $FB    [$8343]     ;} Wait until NMI request acknowledged
		
org $808343
    jmp calc_checksum : nop : nop
post_hook:
		
org !bank_80_free_space_start
hook_init:
    lda #$0080
    sta $1f89
    xba
    sta $1f8a
    stz $1f8c
    rts

calc_checksum:
    lda $1f89           ; curr bank
    bne .do_checksum    ; non-zero = processing
.nmi_wait
    lda $5b4
    bne .nmi_wait
    jmp post_hook
    
.do_checksum
    php
    phb
    rep #$10            ; 16-bit X
    ldx $1f8a           ; curr offset
    lda $1f89           ; bank
    pha
    plb                 ; set DB to current bank
    
.chksum_loop
    lda $0000,x
    clc
    adc $801f8c
    sta $801f8c
    bcc .no_carry
    lda $801f8d
    inc
    sta $801f8d
.no_carry
    inx
    bne .same_bank
    lda $801f89
    inc
    beq .done
    sta $801f89
    pha
    plb                     ; DB++
    lda #$00
    sta $801f8a
    lda #$80
    sta $801f8b
    ldx #$8000
    
.same_bank
    lda $8005b4
    bne .chksum_loop
    rep #$20
    txa
    sta $801f8a             ; save offset
    plb
    plp
    jmp post_hook

.done
    sta $801f89             ; 00 (done)
		plb
    plp
		lda $1f8c
		cmp $ffde
		bne .chkfail
		lda $1f8d
		cmp $ffdf
		bne .chkfail
    bra .nmi_wait
		
.chkfail										; checksum doesnt match whats stored in ROM.. display a red screen and crash.
		stz $2140
		jsr $875d
		jsr $8792
		jsl $808b1a
		jsl $80896e
		lda #$8f
		sta $51
		sta $2100
		stz $4200
		stz $2116
		stz $2117
		lda #$80
		sta $2115
		jsl $8091a9
		db $01,$01,$18
		dw $8000
		db $8e
		dw $4000
		lda #$02
		sta $420b
		stz $2116
		lda #$40
		sta $2117
		lda #$80
		sta $2115
		jsl $8091a9
		db $01,$01,$18
		dw $b437
		db $80
		dw $1000
		lda #$02
		sta $420b
		stz $2121
		jsl $8091a9
		db $01,$00,$22
		dw $e400
		db $8e
		dw $0200
		lda #$02
		sta $420b
		stz $2131
		stz $212d
		lda #$01
		sta $212c
		lda #$0f
		sta $2100
		stz $210b
		lda #$40
		sta $2107
.crash
		bra .crash

print pc
assert pc() <= !bank_80_free_space_end

!_ = $000F
!S = $007C
!E = $006E
!L = $0075
!F = $006F
!G = $0070
!C = $006C
!D = $006D
!H = $0071
!K = $0074
!A = $006A
!I = $0072
!J = $0073
!O = $0078
!R = $007B
!P = $0079
!T = $007D
!U = $007E
!M = $0076
!N = $0077
!V = $007F
!Y = $0082
!o = $0088 ; .
!l = $008A ; left parenthesis
!r = $008B ; right parenthesis
!h = $0087 ; hyphen

org $80B437 ; replace the stock SRAM error with our own .

dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!S,!E,!L,!F,!_,!C,!H,!E,!C,!K,!_,!F,!A,!I,!L,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!C,!O,!R,!R,!U,!P,!T,!_,!R,!O,!M,!_,!D,!E,!T,!E,!C,!T,!E,!D,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!V,!I,!S,!I,!T,!_,!M,!A,!P,!R,!A,!N,!D,!O,!o,!C,!O,!M,!_,!F,!O,!R,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!M,!O,!R,!E,!_,!I,!N,!F,!O,!R,!M,!A,!T,!I,!O,!N,!_,!O,!R,!_,!J,!O,!I,!N,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!T,!H,!E,!_,!D,!I,!S,!C,!O,!R,!D,!_,!F,!O,!R,!_,!H,!E,!L,!P,!o,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!l,!C,!O,!M,!M,!O,!N,!_,!C,!A,!U,!S,!E,!_,!I,!S,!_,!A,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!F,!A,!I,!L,!I,!N,!G,!_,!S,!D,!h,!C,!A,!R,!D,!r,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_
dw !_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_,!_

assert pc() <= !sram_msg_end