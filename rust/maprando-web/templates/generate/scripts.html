<script>
function applyRadioValue(id, value) {
    let el = document.getElementById(id);
    for (inp of el.getElementsByClassName("btn-check")) {
        if (inp.value == String(value)) {
            inp.checked = true;
        }
    }
}
    
function applySkillPreset(preset) {
    for (presetEl of document.getElementsByClassName("skill-preset-button")) {
        if (presetEl.value == preset.preset) {
            presetEl.checked = true;
        } else {
            presetEl.checked = false;
        }
    }

    document.getElementById("shinesparkTiles").value = preset.shinespark_tiles;
    document.getElementById("heatedShinesparkTiles").value = preset.heated_shinespark_tiles;
    document.getElementById("speedBallTiles").value = preset.speed_ball_tiles;
    document.getElementById("shinechargeLeniencyFrames").value = preset.shinecharge_leniency_frames;
    document.getElementById("resourceMultiplier").value = preset.resource_multiplier;
    document.getElementById("gateGlitchLeniency").value = preset.gate_glitch_leniency;
    document.getElementById("doorStuckLeniency").value = preset.door_stuck_leniency;
    document.getElementById("phantoonProficiency").value = preset.phantoon_proficiency;
    document.getElementById("draygonProficiency").value = preset.draygon_proficiency;
    document.getElementById("ridleyProficiency").value = preset.ridley_proficiency;
    document.getElementById("botwoonProficiency").value = preset.botwoon_proficiency;
    document.getElementById("motherBrainProficiency").value = preset.mother_brain_proficiency;
    document.getElementById("escapeTimerMultiplier").value = preset.escape_timer_multiplier;

    for (t of preset.tech_settings) {
        if (t.enabled) {
            document.getElementById(`tech-${t.id}-Yes`).checked = true;    
        } else {
            document.getElementById(`tech-${t.id}-No`).checked = true;    
        }
    }

    for (x of preset.notable_settings) {
        let room_id = x.room_id;
        let notable_id = x.notable_id;
        let combo_id = `${room_id}-${notable_id}`;
        if (x.enabled) {
            document.getElementById(`strat-${combo_id}-Yes`).checked = true;
        } else {
            document.getElementById(`strat-${combo_id}-No`).checked = true;
        }
    }

    updateTierPercent();
}

function fullSettingsChanged() {
    document.getElementById("fullSettingsPreset").value = "";
    document.getElementById("saveSettingsButton").classList.remove("d-none")
}

function presetChanged() {
    let preset = null;
    for (presetEl of document.getElementsByClassName("skill-preset-button")) {
        if (presetEl.checked) {
            preset = skillPresets[presetEl.value];
            applySkillPreset(preset);
            break;
        }
    }
    fullSettingsChanged();
}

function updateTierPercent() {
    let presets = [];
    {% for preset_name in preset_data.difficulty_levels.keys.iter() %}
        {% if preset_name == "Implicit" || preset_name == "Ignored" %}
            {% continue %}
        {% endif %}
        {% let name_no_space = preset_name.replace(" ", "") %}
        presets.push("{{+ name_no_space }}");
    {% endfor %}
    for (p of presets) {
        let els = document.getElementsByClassName("tier-input-" + p);
        let cnt = 0;
        for (e of els) {
            if (e.checked) {
                cnt += 1;
            }
        }
        let percent = Math.round(cnt / els.length * 100);
        if (percent == 0 && cnt > 0) {
            percent = 1;
        }
        if (percent == 100 && cnt < els.length) {
            percent = 99;
        }
        document.getElementById("percent-tier-" + p).innerHTML = percent;
    }
}
function techChanged() {
    {% for p in preset_data.skill_presets.iter() %}
        {% let preset_name = p.preset.as_ref().unwrap() %}
        {% let name_no_space = preset_name.replace(" ", "") %}
        {% if name_no_space == "Implicit" || name_no_space == "Beyond" || name_no_space == "Ignored" %}
            {% continue %}
        {% endif %}
        document.getElementById("preset{{+ name_no_space }}").checked = false;
    {% endfor %}
    updateTierPercent();
    fullSettingsChanged();
}

function tryParseInt(s) {
    if (s == "") {
        return null;
    } else {
        return parseInt(s);
    }
}

function buildSettingsObject() {
    var formData = new FormData(document.getElementById("main-form"));
    let version = {{ version_info.version }};
    let startingItems = [];
    let keyItemPriority = [];
    let fillerItems = [];
    let settings = {
        "version": version,
        "name": formData.get("full_settings_preset"),
        "skill_assumption_settings": {
            "preset": formData.get("preset"),
            "shinespark_tiles": parseFloat(formData.get("shinespark_tiles")),
            "heated_shinespark_tiles": parseFloat(formData.get("heated_shinespark_tiles")),
            "speed_ball_tiles": parseFloat(formData.get("speed_ball_tiles")),
            "shinecharge_leniency_frames": parseFloat(formData.get("shinecharge_leniency_frames")),
            "resource_multiplier": parseFloat(formData.get("resource_multiplier")),
            "gate_glitch_leniency": parseFloat(formData.get("gate_glitch_leniency")),
            "door_stuck_leniency": parseFloat(formData.get("door_stuck_leniency")),
            "phantoon_proficiency": parseFloat(formData.get("phantoon_proficiency")),
            "draygon_proficiency": parseFloat(formData.get("draygon_proficiency")),
            "ridley_proficiency": parseFloat(formData.get("ridley_proficiency")),
            "botwoon_proficiency": parseFloat(formData.get("botwoon_proficiency")),
            "mother_brain_proficiency": parseFloat(formData.get("mother_brain_proficiency")),
            "escape_timer_multiplier": parseFloat(formData.get("escape_timer_multiplier")),
            "tech_settings": buildTechArray(),
            "notable_settings": buildNotableArray(),
        },
        "item_progression_settings": {
            "preset": formData.get("item_progression_preset"),
            "progression_rate": formData.get("progression_rate"),
            "item_placement_style": formData.get("item_placement_style"),
            "item_priority_strength": formData.get("item_priority_strength"),
            "random_tank": formData.get("random_tank") == "true",
            "spazer_before_plasma": formData.get("spazer_before_plasma") == "true",
            "item_pool_preset": formData.get("item_pool_preset"),
            "stop_item_placement_early": formData.get("stop_item_placement_early") == "true",
            "item_pool": buildItemPool(),
            "starting_items_preset": formData.get("starting_items_preset"),
            "starting_items": buildStartingItems(),
            "key_item_priority": buildItemPriorities(),
            "filler_items": buildFillerItems(),
        },
        "quality_of_life_settings": {
            "preset": formData.get("quality_of_life_preset"),
            "item_markers": formData.get("item_markers"),
            "mark_map_stations": formData.get("mark_map_stations") == "true",
            "room_outline_revealed": formData.get("room_outline_revealed") == "true",
            "opposite_area_revealed": formData.get("opposite_area_revealed") == "true",
            "mother_brain_fight": formData.get("mother_brain_fight"),
            "supers_double": formData.get("supers_double") == "true",
            "escape_movement_items": formData.get("escape_movement_items") == "true",
            "escape_refill": formData.get("escape_refill") == "true",
            "escape_enemies_cleared": formData.get("escape_enemies_cleared") == "true",
            "fast_elevators": formData.get("fast_elevators") == "true",
            "fast_doors": formData.get("fast_doors") == "true",
            "fast_pause_menu": formData.get("fast_pause_menu") == "true",
            "respin": formData.get("respin") == "true",
            "infinite_space_jump": formData.get("infinite_space_jump") == "true",
            "momentum_conservation": formData.get("momentum_conservation") == "true",
            "all_items_spawn": formData.get("all_items_spawn") == "true",
            "acid_chozo": formData.get("acid_chozo") == "true",
            "remove_climb_lava": formData.get("remove_climb_lava") == "true",
            "buffed_drops": formData.get("buffed_drops") == "true",
            "early_save": formData.get("early_save") == "true",
        },
        "objectives_mode": formData.get("objectives"),
        "map_layout": formData.get("map_layout"),
        "doors_mode": formData.get("doors"),
        "start_location_mode": formData.get("start_location"),
        "save_animals": formData.get("save_animals"),
        "other_settings": {
            "wall_jump": formData.get("wall_jump"),
            "etank_refill": formData.get("etank_refill"),
            "area_assignment": formData.get("area_assignment"),
            "item_dot_change": formData.get("item_dot_change"),
            "transition_letters": formData.get("transition_letters") == "true",
            "door_locks_size": formData.get("door_locks_size"),
            "maps_revealed": formData.get("maps_revealed"),
            "map_station_reveal": formData.get("map_station_reveal"),
            "energy_free_shinesparks": formData.get("energy_free_shinesparks") == "true",
            "ultra_low_qol": formData.get("ultra_low_qol") == "true",
            "race_mode": formData.get("race_mode") == "true",
            "random_seed": tryParseInt(formData.get("random_seed")),
        }
    };
    return settings;
}

function buildTechArray() {
    let techSelection = [];
    document.querySelectorAll('.tech-input')
    .forEach(function (x) {
        let parts = x.name.split("-");
        let techId = parseInt(parts[1]);
        let enabled = x.checked;
        techSelection.push({
            "id": techId,
            "name": x.getAttribute("data-tech-name"),
            "enabled": enabled,
        });
    });
    return techSelection;
}

function buildNotableArray() {
    let notableSelection = [];
    document.querySelectorAll('.strat-input')
    .forEach(function (x) { 
        let parts = x.name.split("-");
        let roomId = parseInt(parts[1]);
        let notableId = parseInt(parts[2]);
        let enabled = x.checked;
        notableSelection.push({
            "room_id": roomId,
            "notable_id": notableId,
            "room_name": x.getAttribute("data-room-name"),
            "notable_name": x.getAttribute("data-notable-name"),
            "enabled": enabled
        });
    });
    return notableSelection;
}
function buildItemPool() {
    let itemPool = [];
    document.querySelectorAll('.item-pool-input-multiple')
    .forEach(function (x) { 
        // remove prefix: "item_pool_"
        name = x.name.substring(10);
        itemPool.push({"item": name, "count": tryParseInt(x.value)});
    });
    return itemPool;
}
function buildStartingItems() {
    let startingItems = [];
    document.querySelectorAll('.starting-item-input-multiple')
    .forEach(function (x) { 
        // remove prefix: "starting_item_"
        name = x.name.substring(14);
        let cnt = tryParseInt(x.value);
        startingItems.push({"item": name, "count": cnt});
    });
    document.querySelectorAll('.starting-item-input-single')
    .forEach(function (x) { 
        // remove prefix: "starting_item_"
        name = x.name.substring(14);
        if (x.checked && x.value == "Yes") {
            startingItems.push({"item": name, "count": 1});
        } else {
            startingItems.push({"item": name, "count": 0});
        }
    });
    return startingItems;
}
function buildItemPriorities() {
    let itemPriority = [];
    document.querySelectorAll('.item-priority-input')
    .forEach(function (x) { 
        // remove prefix: "item_priority_"
        name = x.name.substring(14);
        // console.log(name + ": " + x.value);
        if (x.checked) {
            itemPriority.push({"item": name, "priority": x.value});
        }
    });
    return itemPriority;
}
function buildFillerItems() {
    let fillerItems = [];
    document.querySelectorAll('.filler-items-input')
    .forEach(function (x) { 
        // remove prefix: "filler_items_"
        name = x.name.substring(13);
        if (x.checked) {
            fillerItems.push({"item": name, "priority": x.value});
        }
    });
    return fillerItems;
}

let submitModal = new bootstrap.Modal('#submitModal', {})
let errorModal = new bootstrap.Modal('#errorModal', {})
let inputRomModal = new bootstrap.Modal('#inputRomModal', {});
let saveSettingsModal = new bootstrap.Modal('#saveSettingsModal', {})
let managePresetsModal = new bootstrap.Modal('#managePresetsModal', {})
let deletePresetModal = new bootstrap.Modal('#deletePresetModal', {})
let renamePresetModal = new bootstrap.Modal('#renamePresetModal', {})
async function prepareSubmit(form) {
    let romEl = document.getElementById("inputRom");
    if (romEl.value == "") {
        inputRomModal.show();
        return;
    }

    let romData = await localforage.getItem('vanillaRomData');
    let hashBuffer = await window.crypto.subtle.digest("SHA-256", romData);
    const hashArray = Array.from(new Uint8Array(hashBuffer)); // convert buffer to byte array
    const hashHex = hashArray
        .map((b) => b.toString(16).padStart(2, "0"))
        .join(""); // convert bytes to hex string
    if (hashHex != "12b77c4bc9c1832cee8881244659065ee1d84c70c3d29e6eaf92e6798cc2ca72") {
        console.log("ROM hash: " + hashHex);
        inputRomModal.show();
        document.getElementById("romInvalid").classList.remove("d-none");
        return;
    }
    document.getElementById("romInvalid").classList.add("d-none");

    // updateTechJSON();
    // updateStratJSON();
    // updateItemPoolJSON();"
    // updateStartingItemJSON();
    // updateItemPriorityJSON();
    // updateFillerItemsJSON();
    submitModal.show();
    // form.submit();

    let settings = buildSettingsObject();
    let formData = new FormData();
    formData.append("spoiler_token", document.getElementById("spoilerToken").value);
    formData.append("settings", JSON.stringify(settings));
    formData.append("rom", romEl.files[0]);
    let errorEl = document.getElementById("errorMsg");
    let response;
    try {
        response = await fetch("/randomize", {
            "method": "POST",
            "body": formData,
        });    
    } catch (e) {
        submitModal.hide();
        errorEl.textContent = `Error: ${e}`;
        errorModal.show();
        return;        
    }
    submitModal.hide();
    if (response.ok) {
        let responseJson = await response.json();
        let seedUrl = responseJson["seed_url"];
        window.location.href = seedUrl;
    } else {
        let responseText = await response.text();
        errorEl.textContent = `Error status ${response.status}: ${responseText}`;
        errorModal.show();
    }
}

function applyQolPreset(preset) {
    for (presetEl of document.getElementsByClassName("qol-preset-button")) {
        if (presetEl.value == preset.preset) {
            presetEl.checked = true;
        } else {
            presetEl.checked = false;
        }
    }

    applyRadioValue("itemMarkers", preset.item_markers);
    applyRadioValue("markMapStations", preset.mark_map_stations);
    applyRadioValue("roomOutlineRevealed", preset.room_outline_revealed);
    applyRadioValue("oppositeAreaRevealed", preset.opposite_area_revealed);
    applyRadioValue("motherBrainFight", preset.mother_brain_fight);
    applyRadioValue("supersDouble", preset.supers_double);
    applyRadioValue("escapeMovementItems", preset.escape_movement_items);
    applyRadioValue("escapeRefill", preset.escape_refill);
    applyRadioValue("escapeEnemiesCleared", preset.escape_enemies_cleared);
    applyRadioValue("fastElevators", preset.fast_elevators);
    applyRadioValue("fastDoors", preset.fast_doors);
    applyRadioValue("fastPauseMenu", preset.fast_pause_menu);
    applyRadioValue("respin", preset.respin);
    applyRadioValue("infiniteSpaceJump", preset.infinite_space_jump);
    applyRadioValue("momentumConservation", preset.momentum_conservation);
    applyRadioValue("allItemsSpawn", preset.all_items_spawn);
    applyRadioValue("acidChozo", preset.acid_chozo);
    applyRadioValue("removeClimbLava", preset.remove_climb_lava);
    applyRadioValue("buffedDrops", preset.buffed_drops);
    applyRadioValue("earlySave", preset.early_save);
}

function applyFullSettingsPreset(preset) {
    document.getElementById("fullSettingsPreset").value = preset.name;
    applySkillPreset(preset.skill_assumption_settings);
    applyItemProgressionPreset(preset.item_progression_settings);
    applyQolPreset(preset.quality_of_life_settings);

    applyRadioValue("objectives", preset.objectives_mode);
    applyRadioValue("mapLayout", preset.map_layout);
    applyRadioValue("doors", preset.doors_mode);
    applyRadioValue("startLocation", preset.start_location_mode);
    applyRadioValue("saveAnimals", preset.save_animals);

    let other = preset.other_settings;
    applyRadioValue("wallJump", other.wall_jump);
    applyRadioValue("etankRefill", other.etank_refill);
    applyRadioValue("areaAssignment", other.area_assignment);
    applyRadioValue("itemDotChange", other.item_dot_change);
    applyRadioValue("transitionLetters", other.transition_letters);
    applyRadioValue("doorLocksSize", other.door_locks_size);
    applyRadioValue("mapsRevealed", other.maps_revealed);
    applyRadioValue("mapStationReveal", other.map_station_reveal);
    applyRadioValue("energyFreeShinesparks", other.energy_free_shinesparks);
    applyRadioValue("ultraLowQoL", other.ultra_low_qol);
    applyRadioValue("raceMode", other.race_mode);
    document.getElementById("randomSeed").value = other.random_seed;
}

async function populateFullPresetOptions() {
    let selectEl = document.getElementById("fullSettingsPreset");
    selectEl.innerHTML = "";

    let optionEl = document.createElement("option");
    optionEl.value = "";
    optionEl.innerText = "Select a preset to automatically fill all settings";
    selectEl.appendChild(optionEl);

    let hrEl = document.createElement("hr");
    selectEl.appendChild(hrEl);

    let customPresets = await localforage.getItem("customPresets");
    if (customPresets === null) {
        customPresets = [];
    }
    if (customPresets.length > 0) {
        for (preset of customPresets) {
            fullPresets[preset.name] = preset;
            optionEl = document.createElement("option");
            optionEl.value = preset.name;
            optionEl.innerText = preset.name;
            selectEl.appendChild(optionEl);    
        }

        hrEl = document.createElement("hr");
        selectEl.appendChild(hrEl);
    }

    for (preset of fullPresetsArr) {
        optionEl = document.createElement("option");
        optionEl.value = preset.name;
        optionEl.innerText = preset.name;
        if (optionEl.value == "Default") {
            optionEl.checked = true;
        }
        selectEl.appendChild(optionEl);
    }
}

function fullSettingsPresetChanged(presetEl) {
    let presetName = presetEl.value;
    if (presetName != "") {
        let preset = fullPresets[presetName];
        applyFullSettingsPreset(preset);
        document.getElementById("saveSettingsButton").classList.add("d-none")
    }
}

function qualityOfLifePresetChanged() {
    for (presetEl of document.getElementsByClassName("qol-preset-button")) {
        if (presetEl.checked) {
            let preset = qolPresets[presetEl.value];
            applyQolPreset(preset);
            break;
        }
    }
    fullSettingsChanged();
}
function qualityOfLifeSettingChanged() {
    document.getElementById("qualityOfLifeOff").checked = false;
    document.getElementById("qualityOfLifeLow").checked = false;
    document.getElementById("qualityOfLifeDefault").checked = false;
    document.getElementById("qualityOfLifeHigh").checked = false;
    document.getElementById("qualityOfLifeMax").checked = false;
    qualityOfLifePresetChanged();
}

function applyItemProgressionPreset(preset) {
    for (presetEl of document.getElementsByClassName("item-preset-button")) {
        if (presetEl.value == preset.preset) {
            presetEl.checked = true;
        } else {
            presetEl.checked = false;
        }
    }

    applyRadioValue("progressionRate", preset.progression_rate);
    applyRadioValue("itemPlacementStyle", preset.item_placement_style);
    applyRadioValue("itemPriorityStrength", preset.item_priority_strength);
    applyRadioValue("randomTank", preset.random_tank);
    applyRadioValue("spazerBeforePlasma", preset.spazer_before_plasma);
    if (preset.item_pool_preset != null) {
        applyRadioValue("itemPoolPreset", preset.item_pool_preset);
    }
    applyRadioValue("stopItemPlacementEarly", preset.stop_item_placement_early);
    for (x of preset.item_pool) {
        let item = x.item;
        let cnt = x.count;
        document.getElementById(`itemPool${item}`).value = cnt;
    }
    if (preset.starting_items_preset != null) {
        applyRadioValue("startingItemsPreset", preset.starting_items_preset);
    }
    for (x of preset.starting_items) {
        let item = x.item;
        let cnt = x.count;
        let el = document.getElementById(`startingItem${item}`);
        if (el.classList.contains("starting-item-input-multiple")) {
            el.value = cnt;
        } else {
            applyRadioValue(`startingItem${item}`, cnt > 0 ? "Yes" : "No");
        }
    }

    for (x of preset.key_item_priority) {
        applyRadioValue(`itemPriority${x.item}`, x.priority);
    }

    for (item in preset.filler_items) {
        let value = preset.filler_items[item];
        applyRadioValue(`fillerItems${item}`, value);
    }
}

function itemProgressionPresetChanged() {
    let preset = null;
    for (presetEl of document.getElementsByClassName("item-preset-button")) {
        if (presetEl.checked) {
            preset = itemPresets[presetEl.value];
            applyItemProgressionPreset(preset);
            break;
        }
    }
    processItemPoolPreset();
    processStartingItemsPreset();
    fullSettingsChanged();
}
function itemProgressionChanged() {
    document.getElementById("itemProgressionPresetNormal").checked = false;
    document.getElementById("itemProgressionPresetTricky").checked = false;
    document.getElementById("itemProgressionPresetChallenge").checked = false;
    document.getElementById("itemProgressionPresetDesolate").checked = false;
    fullSettingsChanged();
}
function processStartingItemsPreset() {
    if (document.getElementById("startingItemsPresetNone").checked) {
        {% for item in starting_items_multiple %}
        document.getElementById("startingItem{{+ item }}").value = "0";
        {% endfor %}
        {% for item in starting_items_single %}
        document.getElementById("startingItem{{+ item }}No").checked = true;
        {% endfor %}
    }
    if (document.getElementById("startingItemsPresetAll").checked) {
        document.getElementById("startingItemMissile").value = "46";
        document.getElementById("startingItemETank").value = "14";
        document.getElementById("startingItemReserveTank").value = "4";
        document.getElementById("startingItemSuper").value = "10";
        document.getElementById("startingItemPowerBomb").value = "10";
        {% for item in starting_items_single %}
        document.getElementById("startingItem{{+ item }}Yes").checked = true;
        {% endfor %}
    }
}
function validateStartingItems() {
    if (parseInt(document.getElementById("startingItemMissile").value) > 46) {
        document.getElementById("startingItemMissile").value = "46";
    }
    if (parseInt(document.getElementById("startingItemETank").value) > 14) {
        document.getElementById("startingItemETank").value = "14";
    }
    if (parseInt(document.getElementById("startingItemReserveTank").value) > 4) {
        document.getElementById("startingItemReserveTank").value = "4";
    }
    if (parseInt(document.getElementById("startingItemSuper").value) > 10) {
        document.getElementById("startingItemSuper").value = "10";
    }
    if (parseInt(document.getElementById("startingItemPowerBomb").value) > 10) {
        document.getElementById("startingItemPowerBomb").value = "10";
    }
}
function startingItemsPresetChanged() {
    processStartingItemsPreset();
    itemProgressionChanged();
}
function startingItemsChanged() {
    document.getElementById("startingItemsPresetNone").checked = false;
    document.getElementById("startingItemsPresetAll").checked = false;
    validateStartingItems();
    itemProgressionChanged();
}

function processItemPoolPreset() {
    if (document.getElementById("itemPoolPresetFull").checked) {
        document.getElementById("stopItemPlacementEarlyNo").checked = true;
        document.getElementById("itemPoolMissile").value = "46";
        document.getElementById("itemPoolSuper").value = "10";
        document.getElementById("itemPoolPowerBomb").value = "10";
        document.getElementById("itemPoolETank").value = "14";
        document.getElementById("itemPoolReserveTank").value = "4";
    }
    if (document.getElementById("itemPoolPresetReduced").checked) {
        document.getElementById("stopItemPlacementEarlyYes").checked = true;
        document.getElementById("itemPoolMissile").value = "12";
        document.getElementById("itemPoolSuper").value = "6";
        document.getElementById("itemPoolPowerBomb").value = "5";
        document.getElementById("itemPoolETank").value = "3";
        document.getElementById("itemPoolReserveTank").value = "3";
    }
}
function validateItemPool() {
    if (parseInt(document.getElementById("itemPoolMissile").value) > 46) {
        document.getElementById("itemPoolMissile").value = "46";
    }
    if (parseInt(document.getElementById("itemPoolETank").value) > 14) {
        document.getElementById("itemPoolETank").value = "14";
    }
    if (parseInt(document.getElementById("itemPoolReserveTank").value) > 4) {
        document.getElementById("itemPoolReserveTank").value = "4";
    }
    if (parseInt(document.getElementById("itemPoolSuper").value) > 19) {
        document.getElementById("itemPoolSuper").value = "19";
    }
    if (parseInt(document.getElementById("itemPoolPowerBomb").value) > 19) {
        document.getElementById("itemPoolPowerBomb").value = "19";
    }

    if (parseInt(document.getElementById("itemPoolMissile").value) < 2) {
        document.getElementById("itemPoolMissile").value = "2";
    }
    if (parseInt(document.getElementById("itemPoolETank").value) < 2) {
        document.getElementById("itemPoolETank").value = "2";
    }
    if (parseInt(document.getElementById("itemPoolReserveTank").value) < 1) {
        document.getElementById("itemPoolReserveTank").value = "1";
    }
    if (parseInt(document.getElementById("itemPoolSuper").value) < 2) {
        document.getElementById("itemPoolSuper").value = "2";
    }
    if (parseInt(document.getElementById("itemPoolPowerBomb").value) < 1) {
        document.getElementById("itemPoolPowerBomb").value = "1";
    }
}
function itemPoolPresetChanged() {
    processItemPoolPreset();
    itemProgressionChanged();
}
function itemPoolChanged() {
    document.getElementById("itemPoolPresetFull").checked = false;
    document.getElementById("itemPoolPresetReduced").checked = false;
    validateItemPool();
    itemProgressionChanged();
}

function gameVariationChanged() {
    if (document.getElementById("ultraLowQoLYes").checked) {
        document.getElementById("qualityOfLifeOff").checked = true;
        qualityOfLifePresetChanged();
    }
    fullSettingsChanged();
}
function initializeSpoilerToken() {
    if (localStorage["spoilerToken"] === undefined) {
        let result = '';
        const length = 80;
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const charactersLength = characters.length;
        let counter = 0;
        while (counter < length) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
            counter += 1;
        }
        localStorage["spoilerToken"] = result;
    }
    document.getElementById("spoilerToken").value = localStorage["spoilerToken"];
}
function checkOtherOptions() {
    document.getElementById("randomSeed").value = "";
    if (document.getElementById("fullSettingsPreset").value !== "") {
        console.log("preset");
        return;
    }
    if (document.getElementById("wallJumpCollectible").checked ||
        document.getElementById("etankRefillDisabled").checked ||
        document.getElementById("etankRefillFull").checked ||
        document.getElementById("energyFreeShinesparksYes").checked ||
        document.getElementById("areaAssignmentRandom").checked ||
        document.getElementById("itemDotChangeDisappear").checked ||
        document.getElementById("transitionLettersNo").checked ||
        document.getElementById("doorLocksSizeSmall").checked ||
        document.getElementById("mapsRevealedPartial").checked ||
        document.getElementById("mapsRevealedFull").checked ||
        document.getElementById("mapStationRevealPartial").checked ||
        document.getElementById("ultraLowQoLYes").checked ||
        document.getElementById("raceModeYes").checked) 
    {
        document.getElementById("collapseGameVariations").classList.remove("collapse");
        document.getElementById("collapseGameVariations").classList.add("show");
    }
}

async function loadSettings() {
    let settings = await localforage.getItem("generateSettings");
    if (settings !== null) {
        await populateFullPresetOptions();
        applyFullSettingsPreset(settings);
        checkOtherOptions();
        document.getElementById("saveSettingsButton").classList.remove("d-none");
    } else {
        // For backwards compatibility: load the form data the old way, if a settings JSON is not stored.
        loadForm(document.getElementById("main-form"));
    }
}

async function saveSettings() {
    let settings = buildSettingsObject();
    await localforage.setItem("generateSettings", settings);
}

async function openSaveSettingsModal() {
    document.getElementById("saveSettingInvalid").classList.add("d-none");
    let datalistEl = document.getElementById("saveSettingsDatalist");
    datalistEl.innerHTML = "";
    let customPresets = await getCustomPresets();
    for (preset of customPresets) {
        let optionEl = document.createElement("option");
        optionEl.value = preset.name;
        datalistEl.appendChild(optionEl);
    }
}

async function getCustomPresets() {
    let customPresets = await localforage.getItem("customPresets");
    if (customPresets === null) {
        customPresets = [];
    }
    return customPresets;
}

async function saveSettingsPreset(ev) {
    ev.preventDefault();
    let name = document.getElementById("saveSettingsName").value;

    let invalidNames = [""];
    for (preset of fullPresetsArr) {
        invalidNames.push(preset.name)
    }
    if (invalidNames.includes(name)) {
        document.getElementById("saveSettingInvalid").classList.remove("d-none");
        console.log("invalid");
        return;   
    }

    let settings = buildSettingsObject();
    settings.name = name;

    let customPresets = await getCustomPresets();

    let found = false;
    for (var i = 0; i < customPresets.length; i++) {
        if (customPresets[i].name == name) {
            customPresets[i] = settings;
            found = true;
            break;
        }
    }
    if (!found) {
        customPresets.push(settings);
    }

    await localforage.setItem("customPresets", customPresets);
    populateFullPresetOptions();
    saveSettingsModal.hide();
}

document.getElementById("saveSettingsForm").addEventListener("submit", saveSettingsPreset);

async function confirmDeletePreset() {
    let presetName = document.getElementById("deletePresetName").innerText;
    let customPresets = await getCustomPresets();

    for (var i = 0; i < customPresets.length; i++) {
        if (customPresets[i].name == presetName) {
            customPresets.splice(i, 1);
            break;
        }
    }
    await localforage.setItem("customPresets", customPresets);
    openManagePresetsModal();

    deletePresetModal.hide();
}

function cancelDeletePreset() {
    deletePresetModal.hide();
}

async function deletePreset(presetName) {
    document.getElementById("deletePresetName").innerText = presetName;
    managePresetsModal.hide();
    deletePresetModal.show();
}

document.getElementById("deletePresetModal").addEventListener('hidden.bs.modal', () => {
    managePresetsModal.show();
});

async function confirmRenamePreset(ev) {
    ev.preventDefault();
    let presetOldName = document.getElementById("renamePresetOldName").innerText;
    let presetNewName = document.getElementById("renamePresetNewName").value;
    let customPresets = await getCustomPresets();

    let invalidNames = [""];
    for (preset of fullPresetsArr) {
        invalidNames.push(preset.name)
    }
    if (invalidNames.includes(presetNewName)) {
        document.getElementById("renamePresetInvalid").classList.remove("d-none");
        return;   
    }

    for (var i = 0; i < customPresets.length; i++) {
        if (customPresets[i].name == presetOldName) {
            customPresets[i].name = presetNewName;
            break;
        }
    }
    await localforage.setItem("customPresets", customPresets);
    openManagePresetsModal();

    renamePresetModal.hide();
}

function cancelRenamePreset() {
    renamePresetModal.hide();
}

async function renamePreset(presetName) {
    document.getElementById("renamePresetOldName").innerText = presetName;
    document.getElementById("renamePresetNewName").value = presetName;
    document.getElementById("renamePresetInvalid").classList.add("d-none");
    managePresetsModal.hide();
    renamePresetModal.show();
}

document.getElementById("renamePresetForm").addEventListener("submit", confirmRenamePreset);
document.getElementById("renamePresetModal").addEventListener('shown.bs.modal', () => {
    document.getElementById("renamePresetNewName").focus()
});
document.getElementById("renamePresetModal").addEventListener('hidden.bs.modal', () => {
    managePresetsModal.show();
});

async function importPreset() {
    let fileEl = document.getElementById("importPresetFile");
    let preset = JSON.parse(await fileEl.files[0].text());
    let customPresets = await getCustomPresets();
    customPresets.push(preset);
    console.log(preset);
    await localforage.setItem("customPresets", customPresets);
    openManagePresetsModal();
}

async function openManagePresetsModal() {
    let customPresets = await getCustomPresets();
    let table = document.getElementById("managePresetsTable");
    table.innerHTML = "";
    for (let preset of customPresets) {
        let row = document.createElement("div");
        row.classList.add("d-flex");
        row.classList.add("preset-row");
        row.classList.add("my-1");
        
        let col = document.createElement("div");
        col.classList.add("mx-1");
        col.classList.add("d-flex");
        col.classList.add("align-items-center");
        col.innerText = preset.name;
        row.appendChild(col);
        
        col = document.createElement("div");
        col.classList.add("ms-auto");

        let renameButton = document.createElement("button");
        renameButton.innerHTML = '<i class="bi bi-pencil"></i>';
        renameButton.classList.add("btn");
        renameButton.classList.add("btn-secondary");
        renameButton.classList.add("m-1");
        renameButton.classList.add("ms-auto");
        renameButton.title = "Rename preset";
        renameButton.addEventListener("click", function() { renamePreset(preset.name); });
        col.appendChild(renameButton);

        let a = document.createElement('a')
        let blob = new Blob([JSON.stringify(preset, null, 4)], {type: "application/json"})
        let url = URL.createObjectURL(blob)
        let filename = `${preset.name}.json`;
        a.setAttribute('href', url);
        a.setAttribute('download', filename);

        let downloadButton = document.createElement("button");
        downloadButton.innerHTML = '<i class="bi bi-download"></i>';
        downloadButton.classList.add("btn");
        downloadButton.classList.add("btn-success");
        downloadButton.classList.add("m-1");
        downloadButton.title = "Download preset";
        a.appendChild(downloadButton);
        col.appendChild(a);

        let deleteButton = document.createElement("button");
        deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
        deleteButton.classList.add("btn");
        deleteButton.classList.add("btn-danger");
        deleteButton.classList.add("m-1");
        deleteButton.title = "Delete preset";
        deleteButton.addEventListener("click", function() { deletePreset(preset.name); });
        col.appendChild(deleteButton);

        row.appendChild(col);
        table.appendChild(row);
    }
}

document.getElementById("managePresetsModal").addEventListener('hidden.bs.modal', () => {
    populateFullPresetOptions();
});

</script>
{% include "../common/save_load_rom.html" %}
<script>
//loadForm(document.getElementById("main-form"));
loadROM(document.getElementById("inputRom"));
loadSettings();
initializeSpoilerToken();
window.addEventListener('pageshow', (event) => {
  if (event.persisted) {
    submitModal.hide();
  }
});
</script>
